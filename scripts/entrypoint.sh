#!/bin/bash

MYSQL_USER=${WORDPRESS_DB_USER:-root}
MYSQL_PASSWORD=${WORDPRESS_DB_PASSWORD:-}

until mysqladmin ping -h"$WORDPRESS_DB_HOSTNAME" --port="$WORDPRESS_DB_PORT" \
  -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" --silent; do
  echo "Database not ready, try again in 3 seconds..."
  sleep 6
done

if [ ! -f /var/www/html/wp-config.php ]; then
    echo "Download WordPress..."
    wp core download --path=/var/www/html --allow-root
fi

if [ ! -f /var/www/html/wp-config.php ]; then
    echo "WordPress configuration..."
    wp config create \
        --dbname="$WORDPRESS_DB_NAME" \
        --dbuser="$WORDPRESS_DB_USER" \
        --dbpass="$WORDPRESS_DB_PASSWORD" \
        --dbhost="$WORDPRESS_DB_HOST" \
        --path=/var/www/html \
        --allow-root
fi

if ! wp core is-installed --path=/var/www/html --allow-root; then
    echo "WordPress installation..."
    wp core install \
        --url="http://localhost:8080" \
        --title="My WordPress" \
        --admin_user="admin" \
        --admin_password="admin" \
        --admin_email="admin@example.com" \
        --path=/var/www/html \
        --allow-root
fi

echo "Really Simple SSL plugin installation..."
wp plugin install really-simple-ssl --version=9.1.1.1 --activate --path=/var/www/html --allow-root

apache2-foreground
